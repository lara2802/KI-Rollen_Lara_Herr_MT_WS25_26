import { fileSearchTool, hostedMcpTool, Agent, RunContext, AgentInputItem, Runner, withTrace } from "@openai/agents";
import { z } from "zod";


// Tool definitions
const fileSearch = fileSearchTool([
  "vs_6922f229419481918b36880f6d322aeb"
])
const mcp = hostedMcpTool({
  serverLabel: "zapier",
  allowedTools: [],
  authorization: "MmYxNmY1NjMtYTg0Yy00ZGUyLTg3YzgtZDJkMmEzZGNmZmE5OjE0MmJlZmMzLTc4ZTEtNDE2OC1iYjRkLTUxZTM5MTlhMGQwYw==",
  requireApproval: "never",
  serverUrl: "https://mcp.zapier.com/api/mcp/mcp"
})
const HiringSuggestionSchema = z.object({ decision_to_hire: z.string(), explanation: z.string() });
const ConfirmhiringSchema = z.object({ to: z.string(), subject: z.string(), body: z.string() });
const hiringSuggestion = new Agent({
  name: "Hiring Suggestion",
  instructions: `Du sprichst ausschließlich Deutsch.

Du bist ein Hiring-Orchestrator.

Eingaben:
- Bewerbungsdatei(en) sowie - Stellenausschreibung über File Search.

Verhalten:
Triff anhand der Dateien genau eine Einstellungsentscheidung. Gib GENAU eine Zeile aus:
Name der einzustellenden Person
<1–2 Sätze mit kurzen erklärung.>

Sende eine E-Mail an die feste Adresse leitung.personalentwicklung@gmail.com 
 mit dem angegebenen Subject und Body.`,
  model: "gpt-5-nano",
  tools: [
    fileSearch,
    mcp
  ],
  outputType: HiringSuggestionSchema,
  modelSettings: {
    reasoning: {
      effort: "low",
      summary: "auto"
    },
    store: true
  }
});

interface ConfirmhiringContext {
  inputOutputParsedExplanation: string;
  inputOutputParsedDecisionToHire: string;
}
const confirmhiringInstructions = (runContext: RunContext<ConfirmhiringContext>, _agent: Agent<ConfirmhiringContext>) => {
  const { inputOutputParsedExplanation, inputOutputParsedDecisionToHire } = runContext.context;
  return `Bestätige, dass die Email versendet wurde (Deutsch). 

leitung.personalentwicklung@gmail.com 

 ${inputOutputParsedExplanation} (kurzer Betreff)
${inputOutputParsedDecisionToHire} 
 ${inputOutputParsedExplanation}`
}
const confirmhiring = new Agent({
  name: "ConfirmHiring",
  instructions: confirmhiringInstructions,
  model: "gpt-5-nano",
  outputType: ConfirmhiringSchema,
  modelSettings: {
    reasoning: {
      effort: "low",
      summary: "auto"
    },
    store: true
  }
});

type WorkflowInput = { input_as_text: string };


// Main code entrypoint
export const runWorkflow = async (workflow: WorkflowInput) => {
  return await withTrace("AgentNoValidationEasy", async () => {
    const state = {
      decision_to_hire: null,
      subject: null,
      body: null
    };
    const conversationHistory: AgentInputItem[] = [
      { role: "user", content: [{ type: "input_text", text: workflow.input_as_text }] }
    ];
    const runner = new Runner({
      traceMetadata: {
        __trace_source__: "agent-builder",
        workflow_id: "wf_6907220a72b081909f2d9cbd5bfa4fdd0f41ac335e4bfee9"
      }
    });
    const hiringSuggestionResultTemp = await runner.run(
      hiringSuggestion,
      [
        ...conversationHistory
      ]
    );
    conversationHistory.push(...hiringSuggestionResultTemp.newItems.map((item) => item.rawItem));

    if (!hiringSuggestionResultTemp.finalOutput) {
        throw new Error("Agent result is undefined");
    }

    const hiringSuggestionResult = {
      output_text: JSON.stringify(hiringSuggestionResultTemp.finalOutput),
      output_parsed: hiringSuggestionResultTemp.finalOutput
    };
    state.body = hiringSuggestionResult.output_parsed.explanation;
    state.subject = hiringSuggestionResult.output_parsed.decision_to_hire;
    const confirmhiringResultTemp = await runner.run(
      confirmhiring,
      [
        ...conversationHistory
      ],
      {
        context: {
          inputOutputParsedExplanation: hiringSuggestionResult.output_parsed.explanation,
          inputOutputParsedDecisionToHire: hiringSuggestionResult.output_parsed.decision_to_hire
        }
      }
    );

    if (!confirmhiringResultTemp.finalOutput) {
        throw new Error("Agent result is undefined");
    }

    const confirmhiringResult = {
      output_text: JSON.stringify(confirmhiringResultTemp.finalOutput),
      output_parsed: confirmhiringResultTemp.finalOutput
    };
  });
}
